<!DOCTYPE html>
<html>
{%include "head.html" %}
{% include "script.html" %}
{% include "js/getPCAscript.html"%}
{% include "js/getShopGroup.html"%}
{% include "js/getShopStaff.html"%}
{% include "js/getShop.html" %}
{% include "js/is_enable.html"%}
	<body>
		<div class="page-content-wrap">
			<form class="layui-form" action="" lay-filter="user-from">
				<div class="layui-inline">
					<label class="layui-form-label">店铺名</label>
					<div class="layui-input-inline">
						<select name="shop_id" lay-search></select>
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">所属品牌</label>
					<div class="layui-input-inline">
						<select name="group_id" lay-search></select>
					</div>
				</div>

				<div class="layui-inline">
					<label class="layui-form-label">状态</label>
					<div class="layui-input-inline">
						<select name="is_enable" lay-search="">
							<option value="">所有</option>
							<option value="true">启用</option>
							<option value="false">禁用</option>
						</select>
					</div>
				</div>
				<button class="layui-btn table-search" lay-submit lay-filter="user-from">搜索</button>
			</form>
			<table class="layui-hide" id="shopTable" lay-filter="shop_table"></table>
		</div>
		<script type="text/html" id="toolShop">
			<div class="layui-btn-container">
				<button class="layui-btn layui-btn-sm layui-icon layui-icon-add-1" title="新增" lay-event="add"></button>
				<!-- <button class="layui-btn layui-btn-danger layui-btn-sm layui-icon layui-icon-close" title="删除"lay-event="is_enable"></button> -->
			</div>
		</script>
		<!-- <script type="text/html" id="baShop">
			<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
			<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">禁用</a>
		</script> -->

		<!-- 管理页面搜索下拉 -->
		<script>
			layui.use('form',function(){
				var form = layui.form;
				//获取店铺
				getShop(true)
				.then(result=>{
					if(result){
						$('select[name="shop_id"]').empty();
						$('select[name="shop_id"]').append(`<option value=''  selected>所有</option>`);
						for(element of result){
							$('select[name="shop_id"]').append(`<option value=${element.shop_id}>${element.name}</option>`);
						}
					}
					form.render();
				})
				.catch(err=>{
					console.error(err)
					$('select[name="shop_id"]').append(`<option value='-1' disable>获取数据失败</option>`);
					form.render();
				})

				//获取品牌
				getShopGroup(true)
				.then(result=>{
					if(result){
						$('select[name="group_id"]').empty();
						$('select[name="group_id"]').append(`<option value=''  selected>所有</option>`);
						for(element of result){
							$('select[name="group_id"]').append(`<option value=${element.group_id}>${element.group_name}</option>`);
						}
					}
				})
				.catch(err=>{
					console.error(err)
						$('select[name="group_id"]').append(`<option value='-1' disable>获取数据失败</option>`);
						form.render();
				})
			}) 
		</script>

		<script>

			layui.use(['table', 'dialog', 'jquery'], function() {
				var table = layui.table;
				var dialog = layui.dialog;
				var $ = layui.jquery;
				const active = {
					//table重载
					tableReload: function (params) {
						table.reload('shopTable', {
							where: {
								"search": params
							}
						});
					}
				}

				var form = layui.form;
				//初始渲染
				table.render({
					elem: '#shopTable'
					,url:'/api/shop/search'
					,method: 'post'
					,height: 'full-160'
					,toolbar: '#toolShop' //开启头部工具栏，并为其绑定左侧模板
					,title: '用户数据表'
					,parseData: function(res) {
						return {
							"code": res['code'],
							"msg": res['message'],
							"count": res['data']['total'],
							"data": res['data']['list']
						}
					}
					,cols: [[
						 {type: 'numbers', title: '序号'}
						,{field:'user_id', title:'ID' ,hide:true, }
						,{field:'name', title:'店铺名', }
						,{field:'shop_logo', title:'店铺logo', align: "center", templet:function(d){
							//let key = d.game_img.split('http://s.qrcode.isecsp.com/game_img_id%')[1].replace(/-/g,'_').replace(/\./g,'_');
							let key = d.shop_id.replace(/-/g,'_')
							return `
								<div id="layer-photos-${key}">
									<img style="display: inline-block; width: 50%; height: 100%;" layer-src="${d.shop_logo}" src="${d.shop_logo}">
								</div>
							`
						}}
						,{field:'p_c_a_text', title:'省市区', }
						//,{field:'open_id', title:'微信ID'}
						,{field:'local_address', title:'详细地址', }
						,{field:'shop_manager', title:'负责人名称', }
						,{field:'mobile', title:'负责人手机号码', }
						,{field:'group_id', title:'	所属连锁品牌id', hide:true,}
						,{field:'group_name', title:'所属品牌', }
						,{field:'license', title:'	营业执照编号', }
						,{field:'longitude', title:'经度', }
						,{field:'latitude', title:'	纬度', }
						,{field:'add_user_name', title:'录入人', }
						,{field:'is_enable', title:'是否启用', templet: function(d){
							if(d.is_enable===true){
								return `<input type="checkbox" name="is_enable" lay-skin="switch" disabled checked lay-text="ON|OFF">`
							}else if(d.is_enable===false){
								return 	`<input type="checkbox" name="is_enable" lay-skin="switch" disabled  lay-text="ON|OFF">`
							}
						}}
						,{field:'add_time', title:'添加时间', templet:function(d){
							return dateFns.format(d.add_time,'YYYY-MM-DD HH:mm')
						} }
						,{fixed:'right', title: "操作", align:'center', minWidth:120,templet:function(d){
							
							if(d.is_enable===true){
								return `<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">禁用</a>`
							}else{
								return `<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">解禁</a>`
							}
							
						}}
					]]
					,done:function(res, curr, count){
						layui.each(res.data,function(index,d){
							let key = d.shop_id.replace(/-/g,'_')
							layer.photos({
								photos: `#layer-photos-${key}`
								,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
							}); 
						});
					}
					,id: 'shopTable'
					,page: true
				});

		
				//监听表单提交
				form.on('submit(user-from)', function(data){
					//console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
					active.tableReload(data.field);
					return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
				});

				//监听行工具事件
				table.on('tool(shop_table)', function(obj){
					var layEvent = obj.event; //获得 lay-event 对应的值
					const url = `/data/shop?shop_id=eq.${obj.data.shop_id}`
					if(layEvent === 'detail'){ //查看
						layer.msg('查看');
						//弹出层引入用户详情页面
					} 
					else if(layEvent === 'is_enable'){ //禁用
						
						if(obj.data.is_enable==true){
				
						layer.confirm(`禁用用户：${obj.data.name}`, function(index){
							//向服务端发送禁用指令,禁用此店铺即代表禁用该店下所有员工
							is_enable(url,false,"shopTable")
							getShopStaff(true,obj.data.shop_id)
							.then(result=>{
								if(result.length!=0){
									for(shop_staff of result){
										let staff_url = `/data/shop_staff?shop_staff_id=eq.${shop_staff.shop_staff_id}`
										is_enable(staff_url,false,"")
									}
								}
							})
							});
						}
						else{		
							layer.confirm(`解禁用户：${obj.data.name}`, function(index){
							//向服务端发送解禁指令,解禁该店下所有员工
							is_enable(url,true,"shopTable")
							getShopStaff(false,obj.data.shop_id)
							.then(result=>{
								if(result.length!=0){
									for(shop_staff of result){
										let staff_url = `/data/shop_staff?shop_staff_id=eq.${shop_staff.shop_staff_id}`
										is_enable(staff_url,true,"")
									}
								}
							})
							});
						}
					}
					else if(layEvent === 'edit'){ //编辑
						//
						//弹出层引入用户修改页面
						//同步更新缓存对应的值 也可以直接重载表格
						function get_qrcode_url(){
							return new Promise((resolve,reject)=>{
								$.ajax({
									url:`/api/tool/get_shop_agent_qrcode?shop_or_agent_id=${obj.data.shop_id}&scene_type=20`,
									type:'GET',
									success:result=>resolve(result),
									error:err=>reject(err)
								})
							})
						}
						layer.open({
						type: 2 ,
						area: ['500px','650px'],
						resize  :false,//是否允许拉伸
						title:"编辑",
						content:`/page/edit_shop`,
						success: function(layero, index){
							var body = layer.getChildFrame('body', index);
							var iframe = window['layui-layer-iframe' + index];
							let p_c_a_value = {
								provinceCode: obj.data.p_c_a_id[0],
								cityCode    : obj.data.p_c_a_id[1],
								areaCode    : obj.data.p_c_a_id[2],
							}

							//初始化省市区
							init_p_c_a(p_c_a_value,body,iframe)

							//初始化品牌
							getShopGroup()
							.then(result=>{
								body.find("select[name='group_id']").empty()
								body.find("select[name='group_id']").append(`<option selected value=''>无所属品牌</option>`)
								body.find("select[name='group_id']").append(`<option value='-1'>请选择</option>`)
								result.map(element=>{
									body.find("select[name='group_id']").append(`<option value=${element.group_id}>${element.group_name}</option>`)
								})								
								iframe.layui.form.render();
								
								//如果有所属品牌
								if(body.find("select[name='group_id']").val()){
									body.find("select[name='group_id']").val(obj.data.group_id);
								}
								iframe.layui.form.render();
							})
							.catch(err=>{
								console.error('err:',err);
								body.find("select[name='group_id']").append(`<option value=''>获取数据失败</option>`);
								iframe.layui.form.render();
							})
							
							//返回二维码url
							get_qrcode_url()
							.then(result=>{
								body.find('#shop_qrcode').empty();
								body.find('#shop_qrcode').append(`<img src='${result}' style="width:100%;" alt="店铺二维码">`);
								iframe.layui.form.render();
							})
							.catch(err=>{
								console.error('err:',err);
								body.find('#shop_qrcode').empty();
								body.find('#shop_qrcode').append(` <b>获取二维码失败</b>`)
								iframe.layui.form.render();
							})


							//var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
							body.find("input[name='shop_id']").val(obj.data.shop_id);
							body.find("input[name='name']").val(obj.data.name);
							body.find("input[name='shop_logo']").val(obj.data.shop_logo);
							body.find("input[name='local_address']").val(obj.data.local_address);
							body.find("input[name='shop_manager']").val(obj.data.shop_manager);
							body.find("input[name='mobile']").val(obj.data.mobile);
							body.find("select[name='group_id']").val(obj.data.group_id);
							body.find("select[name='province']").val(obj.data.p_c_a_id[0]);
							body.find("select[name='city']").val(obj.data.p_c_a_id[1]);
							body.find("select[name='area']").val(obj.data.p_c_a_id[2]);
							body.find("input[name='license']").val(obj.data.license);
							body.find("input[name='longitude']").val(obj.data.longitude);
							body.find("input[name='latitude']").val(obj.data.latitude);
							
							iframe.layui.form.render();
						},
						});    
						// obj.update({
						// 	username: '123'
						// 	,title: 'xxx'
						// });
					}
				});

				//监听事件
				table.on('toolbar(shop_table)', function(obj){
					var checkStatus = table.checkStatus(obj.config.id);

					switch(obj.event){
						case 'add':
							 
							layer.open({
								type: 2 ,
								area: ['500px','650px'],
								title:"添加店铺",
								content: "/page/add_shop",
								success: function(layero, index){
									var body = layer.getChildFrame('body', index);
									body.find("form[class='layui-form']").val(index);
								},
							})
						break;
						case 'is_enable':
							let data = checkStatus['data'];
							if (data.length > 0) {
							let ids = [];
								$.each(data, function (i, tem) {
									ids.push(tem['user_id']);
								});
								dialog.confirm({
									message:'您确定要删除选中项',
									success:function(){
										staticActive.delBatch(ids, '删除API');
										layer.msg('删除了')
									},
									cancel:function(){
										layer.msg('取消了')
									}
								})
								return false;
							} else {
								layer.msg('没有选中行');
							}
						break;
					};
				});
			});
		</script>
	</body>

</html>