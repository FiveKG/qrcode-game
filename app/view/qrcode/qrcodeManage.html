<!DOCTYPE html>
<html>
{%include "head.html" %}
{% include "script.html" %}
	<body>
		<div class="page-content-wrap">
			<form class="layui-form" action="" lay-filter="user-from">
				<div class="layui-inline">
					<label class="layui-form-label">经销商</label>
					<div class="layui-input-inline">
						<select name="agent_id" lay-search></select>
					</div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">所属品牌</label>
                    <div class="layui-input-inline">
						<select name="group_id" lay-search></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">所属店铺</label>
                    <div class="layui-input-inline">
						<select name="shop_id" lay-search></select>
                    </div>
                </div>
				<div class="layui-inline">
					<label class="layui-form-label">状态</label>
					<div class="layui-input-inline">
						<select name="is_enable" lay-search="">
							<option value="true">启用</option>
							<option value="false">禁用</option>
						</select>
					</div>
				</div>
                <button class="layui-btn table-search" lay-submit lay-filter="user-from">搜索</button>

            </form>

			<table class="layui-hide" id="qrcodeTable" lay-filter="qrcode_table"></table>
		</div>
		<script type="text/html" id="toolqrcode">
			<div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm layui-icon layui-icon-add-1" title="新增" lay-event="add"></button>
                <button class="layui-btn layui-btn-sm layui-btn-sm layui-icon layui-icon-file" title="生成二维码" lay-event='generateQrCode' ></button>
				<!-- <button class="layui-btn layui-btn-danger layui-btn-sm layui-icon layui-icon-close" title="删除"lay-event="is_enable"></button> -->
			</div>
		</script>
		<!-- <script type="text/html" id="baqrcode">
			<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
			<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">禁用</a>
		</script> -->

	    <!-- 搜索下拉 -->
		<script>
		layui.use('form',function(){
			var form = layui.form;
				//获取经销商
				$.ajax({
					url        : `/data/agent?select=agent_id,name`,
					type       : "GET",
					success	:function(result){
						if(result){
						$('select[name="agent_id"]').empty();
						$('select[name="agent_id"]').append(`<option value=''  selected>所有</option>`);
						for(element of result){
						$('select[name="agent_id"]').append(`<option value=${element.agent_id}>${element.name}</option>`);
						}
						}else{
							$('select[name="agent_id"]').append(`<option value='' disable>无数据</option>`);
						}
					},
					error:function(err){
						console.log('select[name="agent_id"] err:',err)
						$('select[name="agent_id"]').append(`<option value='-1' disable>获取数据失败</option>`);
						form.render();
					}
				})		

			//获取店铺
				$.ajax({
				url        : `/data/shop?select=shop_id,name`,
				type       : "GET",
				success	:function(result){
					if(result){
						$('select[name="shop_id"]').empty();
						$('select[name="shop_id"]').append(`<option value=''  selected>所有</option>`);
						for(element of result){
							$('select[name="shop_id"]').append(`<option value=${element.shop_id}>${element.name}</option>`);
						}
					}else{
						$('select[name="shop_id"]').append(`<option value='' disable>无数据</option>`);
					}
					form.render();
				},
				error:function(err){
					console.log('select[name="shop_id"] err:',err)
					$('select[name="shop_id"]').append(`<option value='-1' disable>获取数据失败</option>`);
					form.render();
				}
				
			})
			//获取品牌
				$.ajax({
				url        : `/data/shop_group?select=group_id,group_name`,
				type       : "GET",
				success	:function(result){
					if(result){
						$('select[name="group_id"]').empty();
						$('select[name="group_id"]').append(`<option value=''  selected>所有</option>`);
						for(element of result){
							$('select[name="group_id"]').append(`<option value=${element.group_id}>${element.group_name}</option>`);
						}
					}else{
						$('select[name="group_id"]').append(`<option value='' disable>无数据</option>`);
					}
					form.render();
				},
				error:function(err){
					console.log('select[name="group_id"] err:',err)
					$('select[name="group_id"]').append(`<option value='-1' disable>获取数据失败</option>`);
					form.render();
				}
			})
		}) 
    	</script>

		<script>
			layui.use(['table', 'dialog', 'jquery'], function() {
				var table = layui.table;
				var dialog = layui.dialog;
				var $ = layui.jquery;
				const active = {
					//table重载
					tableReload: function (params) {
						table.reload('qrcodeTable', {
							where: {
								"search": params
							}
						});
					}
				}

				var form = layui.form;
				//初始渲染
				table.render({
					elem: '#qrcodeTable'
					,url:'/api/qrcode/search'
					,method: 'post'
					,toolbar: '#toolqrcode' //开启头部工具栏，并为其绑定左侧模板
					,title: '用户数据表'
					,parseData: function(res) {
						return {
							"code": res['code'],
							"msg": res['message'],
							"count": res['data']['total'],
							"data": res['data']['list']
						}
					}
					,cols: [[
						{type: 'checkbox', fixed: 'left'}
						,{field:'qrcode_id', title:'主键',hide:true }
						,{field:'scan_action', title:'扫码后的动作',templet(d){
                            return JSON.stringify(d.scan_action)
                        } }
						,{field:'download_url', title:'下载地址', }
						,{field:'agent_name', title:'生成于经销商', }
						,{field:'shop_name', title:'所属店铺', }
						,{field:'group_name', title:'所属品牌', }
						,{field:'hash_str', title:'内容hash', }
						,{field:'seq', title:'序号', }
						,{field:'is_enable', title:'是否可用',hide:true }
						,{field:'add_time', title:'添加的时间', hide:true}
						,{field:'add_user_id', title:'创建二维码的用户的', hide:true}
						,{field:'add_user_name', title:'录入人', }
						,{field:'is_enable', title:'是否启用', templet: function(d){
							if(d.is_enable===true){
								return '是'
							}else if(d.is_enable===false){
								return 	'否'
							}
						}}
						,{field:'add_time', title:'添加时间', templet:function(d){
							return dateFns.format(d.add_time,'YYYY-MM-DD HH:mm')
						} }
						,{fixed:'right', title: "操作", align:'center', templet:function(d){
							
							if(d.is_enable===true){
								return `<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">禁用</a>`
							}else{
								return `<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" name='is_enable' lay-event="is_enable">解禁</a>`
							}
							
						}}
					]]
					,id: 'qrcodeTable'
					,page: true
				});

		
				//监听表单提交
				form.on('submit(user-from)', function(data){
					//console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
					active.tableReload(data.field);
					return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
				});

	
				//监听行工具事件
				table.on('tool(qrcode_table)', function(obj){
					var layEvent = obj.event; //获得 lay-event 对应的值
					if(layEvent === 'detail'){ //查看
						layer.msg('查看');
						//弹出层引入用户详情页面
					} 
					else if(layEvent === 'is_enable'){ //删除
						
						if(obj.data.is_enable==true){
						layer.confirm(`禁用：shop_name=${obj.data.shop_name},seq=${obj.data.seq}`, function(index){
							//向服务端发送禁用指令
							$.ajax({
								url     : `/data/qrcode?qrcode_id=eq.${obj.data.qrcode_id}`,
								type    : "PATCH",
								dataType: "json",
								data    : JSON.stringify({"is_enable":false}),
								contentType: 'application/json; charset=utf-8',
								success: function(data){
									if(!data){
										layer.msg('更新成功!');
									}else{
										layer.msg('更新失败!');
									}
									setTimeout(function(){ 
										table.reload("qrcodeTable")
										}, 1000);	
								}
							})
							});
						}
						else{		
							layer.confirm(`解禁：shop_name=${obj.data.shop_name},seq=${obj.data.seq}`, function(index){
							//向服务端发送接近指令
							$.ajax({
								url     : `/data/qrcode?qrcode_id=eq.${obj.data.qrcode_id}`,
								type    : "PATCH",
								dataType: "json",
								data    : JSON.stringify({"is_enable":true}),
								contentType: 'application/json; charset=utf-8',
								success: function(data){
									if(!data){
										layer.msg('更新成功!');
									}else{
										layer.msg('更新失败!');
									}
										table.reload("qrcodeTable")	
								}
							})
							});
						}
					}
					else if(layEvent === 'edit'){ //编辑
						//layer.msg('编辑');
						//弹出层引入用户修改页面
						//同步更新缓存对应的值 也可以直接重载表格
						layer.open({
						type: 2 ,
						area: ['500px', '650px'],
						title:"编辑",
						content:`/page/edit_qrcode`,
						success: function(layero, index){
							var body = layer.getChildFrame('body', index);
							//console.log(obj.data)
							//var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
							body.find("input[name='qrcode_id']").val(obj.data.qrcode_id);
							body.find("textarea[name='scan_action']").val(JSON.stringify(obj.data.scan_action,null,4));
							body.find("input[name='download_url']").val(obj.data.download_url);
							body.find("input[name='agent_id']").val(obj.data.agent_id);
							body.find("input[name='shop_id']").val(obj.data.shop_id);
							body.find("input[name='group_id']").val(obj.data.group_id);
							body.find("textarea[name='hash_str']").val(obj.data.hash_str);
							body.find("input[name='seq']").val(obj.data.seq);
							body.find("input[name='is_enable']").val(obj.data.is_enable);
							body.find("input[name='add_time']").val(obj.data.add_time);
							body.find("input[name='add_user_id']").val(obj.data.create_user_id);
							var iframe = window['layui-layer-iframe' + index];

							var data = {
                                agent_id  : obj.data.agent_id,
                                shop_id   : obj.data.shop_id,
                                group_id  : obj.data.group_id,
                                agent_name: obj.data.agent_name,
                                shop_name : obj.data.shop_name,
                                group_name: obj.data.group_name
							}
							iframe.init(data)
						},

						});    
						// obj.update({
						// 	username: '123'
						// 	,title: 'xxx'
						// });
					}
				});

				//监听事件
				table.on('toolbar(qrcode_table)', function(obj){
					var checkStatus = table.checkStatus(obj.config.id);

					switch(obj.event){
						case 'add':
							layer.msg('添加');
							layer.open({
								type: 2 ,
								area: ['500px', '450px'],
								title:"添加",
								content: "/page/add_qrcode",
								success: function(layero, index){
									var body = layer.getChildFrame('body', index);
                                    body.find("form[class='layui-form']").val(index);
                                    
								},
							})
                        break;
                        case 'generateQrCode':
                                layer.msg('生成二维码');
                                layer.open({
                                    type: 2 ,
									area: ['950px', '650px'],
									resize :false,
                                    title:"生成二维码",
                                    content: "/page/qrcode/download_qrcode",
                                    success: function(layero, index){
                                        var body = layer.getChildFrame('body', index);
                                        body.find("form[class='layui-form']").val(index);
                                        
                                    },
                                })
						break;
						case 'is_enable':
							let data = checkStatus['data'];
							if (data.length > 0) {
							let ids = [];
								$.each(data, function (i, tem) {
									ids.push(tem['user_id']);
								});
								dialog.confirm({
									message:'您确定要删除选中项',
									success:function(){
										staticActive.delBatch(ids, '删除API');
										layer.msg('删除了')
									},
									cancel:function(){
										layer.msg('取消了')
									}
								})
								return false;
							} else {
								layer.msg('没有选中行');
							}
						break;
					};
				});
			});
		</script>
	</body>

</html>